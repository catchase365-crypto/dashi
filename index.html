<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯·æ•™å¤§å¸ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans SC', sans-serif; -webkit-font-smoothing: antialiased; overscroll-behavior: none; }
        .chat-bubble { max-width: 90%; word-wrap: break-word; position: relative; }
        /* ç”¨æˆ·çš„æ¶ˆæ¯æ°”æ³¡ */
        .chat-bubble.user { 
            background-color: #3b82f6; 
            align-self: flex-end; 
            padding: 0.75rem 1.25rem; 
            border-radius: 1.25rem;
            text-align: left;
        }
        /* å¤§å¸ˆçš„æ¶ˆæ¯æ°”æ³¡ */
        .chat-bubble.model { 
            background-color: #374151; 
            align-self: flex-start; 
            padding: 0.75rem 1.25rem; 
            border-radius: 1.25rem; 
        }
        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        /* ä¾§è¾¹æ è¿‡æ¸¡ */
        #sidebar { transition: transform 0.3s ease-in-out; }
        .context-menu { position: absolute; z-index: 100; display: none; }

        /* åé—®æŒ‰é’®çš„æ ·å¼ */
        .follow-up-btn {
            background-color: #4b5563; /* ç°è‰² */
            border: 1px solid #6b7280;
            padding: 0.5rem 1rem;
            border-radius: 1rem;
            text-align: left;
            transition: background-color 0.2s;
        }
        .follow-up-btn:hover {
            background-color: #525f73;
        }
        .follow-up-btn:disabled {
            opacity: 0.5;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex items-center justify-center h-screen overflow-hidden">

    <!-- ä¾§è¾¹æ  (å†å²è®°å½•) -->
    <aside id="sidebar" class="absolute top-0 left-0 h-full w-64 bg-gray-900 border-r border-gray-700 z-40 transform -translate-x-full flex flex-col"></aside>
    <div id="sidebar-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-30"></div>

    <!-- ä¸»åº”ç”¨å®¹å™¨ -->
    <div id="app-container" class="w-full max-w-3xl h-screen md:h-[95vh] md:rounded-2xl flex flex-col bg-gray-800 shadow-2xl overflow-hidden">
        <main id="main-content" class="flex flex-1 flex-col h-full"></main>
    </div>

    <!-- è®¾ç½® Modals -->
    <div id="settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50"></div>
    <div id="topic-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50"></div>

<script>
    // --- çŠ¶æ€ç®¡ç† ---
    let isLoading = false;
    let apiKey = '';
    let currentTopic = 'ç»¼åˆçŸ¥è¯†';
    let allHistories = {}; // å­˜å‚¨æ‰€æœ‰å¯¹è¯å†å²
    let currentFollowUps = []; // å½“å‰å¯ç”¨çš„åé—®

    // --- DOM å…ƒç´  ---
    const mainContent = document.getElementById('main-content');
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    const settingsModal = document.getElementById('settings-modal');
    const topicModal = document.getElementById('topic-modal');

    // --- AI é…ç½® (å·²æ›´æ–°) ---
    const BASE_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=';
    
    // æ–°çš„ JSON Schema
    const generationConfig = { 
        responseMimeType: "application/json", 
        responseSchema: { 
            type: "OBJECT", 
            properties: { 
                response_text: { type: "STRING" }, 
                follow_up_prompts: { 
                    type: "ARRAY", 
                    items: { type: "STRING" } 
                } 
            }, 
            required: ["response_text", "follow_up_prompts"] 
        } 
    };
    
    // --- è¾…åŠ©å‡½æ•° ---
    function openSettingsModal() { settingsModal.classList.remove('hidden'); document.getElementById('api-key-input').value = apiKey; }
    function closeSettingsModal() { settingsModal.classList.add('hidden'); }
    function openTopicModal() { topicModal.classList.remove('hidden'); document.getElementById('topic-input').value = currentTopic; }
    function closeTopicModal() { topicModal.classList.add('hidden'); }
    function toggleSidebar() { sidebar.classList.toggle('-translate-x-full'); sidebarOverlay.classList.toggle('hidden'); }

    function saveApiKey() { 
        const newKey = document.getElementById('api-key-input').value.trim(); 
        if (newKey) { 
            apiKey = newKey; 
            localStorage.setItem('geminiApiKey', newKey); 
            closeSettingsModal(); 
            // å¦‚æœå½“å‰å¯¹è¯ä¸ºç©ºï¼Œè‡ªåŠ¨å¼€å§‹
            if (!allHistories[currentTopic] || allHistories[currentTopic].history.length === 0) {
                 switchTopic(currentTopic, true);
            } 
        } else { 
            // ä¸ä½¿ç”¨ alert
            console.warn('è¯·è¾“å…¥æœ‰æ•ˆçš„ API Keyã€‚');
        } 
    }

    function saveTopicAndStart() { 
        const newTopic = document.getElementById('topic-input').value.trim(); 
        if (newTopic) { 
            closeTopicModal(); 
            switchTopic(newTopic, !allHistories[newTopic]); 
        } else { 
            console.warn('è¯·è¾“å…¥æœ‰æ•ˆçš„ä¸»é¢˜å…³é”®è¯ã€‚');
        } 
    }
    
    // --- åˆå§‹åŒ– ---
    document.addEventListener('DOMContentLoaded', initializeApp);

    function initializeApp() {
        renderModals();
        renderSidebar();
        loadAllHistories();
        renderHistoryList();
        const lastTopic = localStorage.getItem('masterLastTopic') || 'é‡å­åŠ›å­¦';
        switchTopic(lastTopic);
        if (!loadApiKey()) openSettingsModal();
        setupGlobalEventListeners();
    }

    function setupGlobalEventListeners() {
        sidebarOverlay.addEventListener('click', toggleSidebar);
        // å…¨å±€ç‚¹å‡»ï¼Œç”¨äºå…³é—­å³é”®èœå•
        document.body.addEventListener('click', (e) => {
            if (!e.target.closest('.context-menu-parent')) closeContextMenu();
        });
        // ç§»é™¤æ—§çš„é”®ç›˜å¿«æ·é”®
    }

    // --- æ ¸å¿ƒæ¸²æŸ“å‡½æ•° ---
    function renderChatInterface() {
        currentMode = 'chat'; // æ¨¡å¼æ”¹ä¸º 'chat'
        mainContent.innerHTML = `
            <header class="bg-gray-900/50 backdrop-blur-sm p-4 border-b border-gray-700 flex items-center justify-between flex-shrink-0">
                <button id="sidebar-toggle-btn" title="æ‰“å¼€å†å²" class="text-gray-400 hover:text-white transition"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" /></svg></button>
                <h2 id="topic-title" class="text-xl font-bold text-white truncate px-2"></h2>
                <div class="flex items-center space-x-4">
                    <button id="topic-btn" title="è®¾ç½®ä¸»é¢˜" class="text-gray-400 hover:text-white transition"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg></button>
                    <button id="settings-btn" title="è®¾ç½®API" class="text-gray-400 hover:text-white transition"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg></button>
                    <button id="restart-btn" class="text-sm text-gray-400 hover:text-white transition">æ–°å¯¹è¯</button>
                </div>
            </header>
            <main id="chat-messages" class="flex-1 p-6 overflow-y-auto flex flex-col space-y-4"></main>
            <div id="loading-spinner" class="hidden p-6 flex items-center justify-center flex-shrink-0"><div class="flex items-center space-x-2 text-gray-400"><svg class="h-6 w-6 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>å¤§å¸ˆæ­£åœ¨æ€è€ƒ...</span></div></div>
            <footer class="p-4 border-t border-gray-700 bg-gray-800 flex-shrink-0">
                <div id="options-container" class="flex flex-col space-y-3"></div>
            </footer>
        `;
        // ç»‘å®šæ–°äº‹ä»¶
        document.getElementById('restart-btn').addEventListener('click', () => switchTopic(currentTopic, true));
        document.getElementById('settings-btn').addEventListener('click', openSettingsModal);
        document.getElementById('topic-btn').addEventListener('click', openTopicModal);
        document.getElementById('sidebar-toggle-btn').addEventListener('click', toggleSidebar);
        
        // å§”æ‰˜äº‹ä»¶ç›‘å¬å™¨
        document.getElementById('options-container').addEventListener('click', (e) => {
            const button = e.target.closest('.follow-up-btn');
            if (button && !isLoading) {
                handleFollowUpClick(button.dataset.prompt);
            }
        });
        
        document.getElementById('topic-title').textContent = currentTopic;
    }

    function renderModals() {
        // è®¾ç½® Modal
        settingsModal.innerHTML = `<div class="bg-gray-800 rounded-2xl p-8 w-full max-w-md shadow-2xl border border-gray-700"><h2 class="text-2xl font-bold mb-4 text-white">è®¾ç½® API å¯†é’¥</h2><p class="text-gray-400 mb-6">è¯·è¾“å…¥æ‚¨çš„ Google Gemini API å¯†é’¥ã€‚</p><label for="api-key-input" class="block text-sm font-medium text-gray-300 mb-2">API KEY:</label><input type="password" id="api-key-input" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 focus:ring-2 focus:ring-blue-500"><div class="mt-6 flex justify-end space-x-4"><button id="cancel-settings-btn" class="py-2 px-5 bg-gray-600 hover:bg-gray-500 rounded-lg transition">å–æ¶ˆ</button><button id="save-settings-btn" class="py-2 px-5 bg-blue-600 hover:bg-blue-700 rounded-lg transition">ä¿å­˜</button></div></div>`;
        
        // ä¸»é¢˜ Modal (æ›´æ–°æ–‡æ¡ˆ)
        topicModal.innerHTML = `<div class="bg-gray-800 rounded-2xl p-8 w-full max-w-md shadow-2xl border border-gray-700"><h2 class="text-2xl font-bold mb-4 text-white">è®¾ç½®è¯·æ•™ä¸»é¢˜</h2><p class="text-gray-400 mb-6">è¯·è¾“å…¥æ‚¨æƒ³è¯·æ•™çš„ä¸»é¢˜ï¼Œä¾‹å¦‚ "é‡å­åŠ›å­¦"ã€‚</p><label for="topic-input" class="block text-sm font-medium text-gray-300 mb-2">ä¸»é¢˜å…³é”®è¯:</label><input type="text" id="topic-input" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 focus:ring-2 focus:ring-blue-500"><div class="mt-6 flex justify-end space-x-4"><button id="cancel-topic-btn" class="py-2 px-5 bg-gray-600 hover:bg-gray-500 rounded-lg transition">å–æ¶ˆ</button><button id="save-topic-btn" class="py-2 px-5 bg-blue-600 hover:bg-blue-700 rounded-lg transition">å¼€å§‹è¯·æ•™</button></div></div>`;
        
        // ç»‘å®š Modal äº‹ä»¶
        document.getElementById('cancel-settings-btn').addEventListener('click', closeSettingsModal);
        document.getElementById('save-settings-btn').addEventListener('click', saveApiKey);
        document.getElementById('cancel-topic-btn').addEventListener('click', closeTopicModal);
        document.getElementById('save-topic-btn').addEventListener('click', saveTopicAndStart);
    }
    
    // ä¾§è¾¹æ  (ç§»é™¤é”™é¢˜ç›¸å…³)
    function renderSidebar() {
        sidebar.innerHTML = `
            <div class="p-4 border-b border-gray-700">
                <h3 class="text-lg font-bold text-white">å¯¹è¯å†å²</h3>
            </div>
            <nav id="history-list" class="flex-1 overflow-y-auto p-2"></nav>
            <div class="p-4 border-t border-gray-700">
                <button id="clear-history-btn" class="w-full text-sm text-red-400 hover:text-red-300 bg-red-900/50 hover:bg-red-900/80 py-2 rounded-lg transition-colors">æ¸…é™¤æ‰€æœ‰è®°å½•</button>
            </div>
        `;
        document.getElementById('clear-history-btn').addEventListener('click', clearAllHistory);
    }
    
    // --- æ ¸å¿ƒ API è°ƒç”¨ (å·²é‡å†™) ---
    async function fetchMasterResponse(promptText) {
        if (!apiKey) { 
            openSettingsModal(); 
            return; 
        }
        setLoading(true);
        
        // æ„å»ºå¤§å¸ˆçš„ Prompt
        const systemPrompt = `ä½ æ˜¯ä¸€ä½åšå­¦å¤šè¯†çš„â€œå¤§å¸ˆâ€ã€‚ä½ çš„ä»»åŠ¡æ˜¯ï¼š
1.  å§‹ç»ˆæ‰®æ¼”â€œå¤§å¸ˆâ€çš„è§’è‰²ï¼Œç”¨ç®€æ´ã€æ·±åˆ»ã€å¯å‘æ€§çš„è¯­è¨€å›ç­”ç”¨æˆ·çš„é—®é¢˜ã€‚
2.  ä½ çš„å›ç­” (response_text) ä¸åº”è¿‡é•¿ï¼Œä¿æŒåœ¨1-3ä¸ªæ®µè½å†…ã€‚
3.  åœ¨å›ç­”çš„æœ€åï¼Œä½ å¿…é¡»æä¾› 3 åˆ° 4 ä¸ªé«˜è´¨é‡çš„ã€å¼•å¯¼æ€§çš„â€œåé—®â€ (follow_up_prompts)ï¼Œè¿™äº›é—®é¢˜èƒ½å¸®åŠ©ç”¨æˆ·æ›´æ·±å…¥åœ°æ¢ç´¢ç›¸å…³ä¸»é¢˜ã€‚
4.  ä½ çš„å›å¤å¿…é¡»ä¸¥æ ¼éµå¾ªæŒ‡å®šçš„JSONæ ¼å¼ã€‚`;
        
        const userMessage = promptText;
        
        const payload = { 
            contents: [{ role: 'user', parts: [{ text: userMessage }] }], 
            systemInstruction: { parts: [{ text: systemPrompt }] }, 
            generationConfig 
        };
        
        try {
            const response = await fetch(BASE_API_URL + apiKey, { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' }, 
                body: JSON.stringify(payload) 
            });
            
            if (!response.ok) { 
                const errorBody = await response.json(); 
                throw new Error(`API è¯·æ±‚å¤±è´¥: ${errorBody.error.message}`); 
            }
            
            const result = await response.json();
            const candidate = result.candidates?.[0];
            
            if (!candidate?.content?.parts?.[0]?.text) {
                throw new Error("è¿”å›çš„æ•°æ®ç»“æ„æ— æ•ˆã€‚");
            }
            
            const rawText = candidate.content.parts[0].text;
            
            try {
                // æ¸…ç†å¯èƒ½çš„ markdown æ ‡è®°
                const cleanedText = rawText.trim().replace(/```json|```/g, '').trim();
                const jsonResponse = JSON.parse(cleanedText);
                
                if (!jsonResponse.response_text || !jsonResponse.follow_up_prompts) {
                    throw new Error("è¿”å›çš„JSONç¼ºå°‘ 'response_text' æˆ– 'follow_up_prompts'ã€‚");
                }

                // æ·»åŠ åˆ°å†å²
                addHistoryItem({ type: 'model', content: jsonResponse });
                // æ¸²æŸ“åˆ°UI
                addMessageToUI(jsonResponse, 'model');
                // æ¸²æŸ“æ–°çš„åé—®æŒ‰é’®
                currentFollowUps = jsonResponse.follow_up_prompts;
                renderFollowUpButtons(currentFollowUps, true);

            } catch (parseError) { 
                handleError("JSON è§£æå¤±è´¥", rawText, parseError); 
            }
        } catch (error) { 
            handleError('è°ƒç”¨ Gemini API æ—¶å‡ºé”™', null, error); 
        } finally { 
            setLoading(false); 
        }
    }
    
    // --- äº¤äº’å¤„ç† (å·²é‡å†™) ---
    function handleFollowUpClick(promptText) {
        if (isLoading) return;
        
        // 1. å°†ç”¨æˆ·çš„é€‰æ‹©æ·»åŠ åˆ°å†å²
        addHistoryItem({ type: 'user', content: promptText });
        
        // 2. å°†ç”¨æˆ·çš„é€‰æ‹©æ¸²æŸ“åˆ°UI
        addMessageToUI(promptText, 'user');
        
        // 3. æ¸…ç©ºå¹¶ç¦ç”¨æŒ‰é’®
        currentFollowUps = [];
        renderFollowUpButtons([], false); // ç¦ç”¨å¹¶æ¸…ç©º
        
        // 4. è·å–å¤§å¸ˆçš„æ–°å›å¤
        fetchMasterResponse(promptText);
    }
    
    // --- å†å²å’Œä¸»é¢˜ç®¡ç† (å·²ç®€åŒ–) ---
    function switchTopic(topic, forceNew = false) {
        currentTopic = topic;
        localStorage.setItem('masterLastTopic', topic); // ä½¿ç”¨æ–°çš„ key
        renderChatInterface(); // æ¸²æŸ“èŠå¤©ç•Œé¢
        currentFollowUps = [];
        
        if (allHistories[currentTopic] && !forceNew) {
            loadChatFromHistory();
        } else {
            // åˆ›å»ºæ–°çš„å†å²
            if (!allHistories[currentTopic] || forceNew) {
                allHistories[currentTopic] = { 
                    history: [],
                    pinned: allHistories[currentTopic]?.pinned || false // ä¿ç•™å›ºå®šçŠ¶æ€
                };
            }
            saveAllHistories();
            // å°†ä¸»é¢˜ä½œä¸ºç¬¬ä¸€ä¸ªé—®é¢˜å‘é€
            handleFollowUpClick(currentTopic);
        }
        renderHistoryList();
        if (sidebar.classList.contains('translate-x-0')) {
           toggleSidebar();
        }
    }
    
    function loadChatFromHistory() {
        const topicData = allHistories[currentTopic] || { history: [] };
        const history = topicData.history;
        const chatMessagesEl = document.getElementById('chat-messages');
        if (!chatMessagesEl) return;
        chatMessagesEl.innerHTML = '';
        
        let lastModelItem = null;
        
        history.forEach((item, index) => {
            if (item.type === 'model') {
                addMessageToUI(item.content, 'model');
                lastModelItem = item;
            } else if (item.type === 'user') {
                addMessageToUI(item.content, 'user');
            }
            // ç§»é™¤äº† feedback é€»è¾‘
        });
        
        if (lastModelItem) {
            // æ¢å¤ä¸Šä¸€è½®çš„åé—®æŒ‰é’®
            currentFollowUps = lastModelItem.content.follow_up_prompts || [];
            renderFollowUpButtons(currentFollowUps, true);
        } else {
            // å¦‚æœå†å²ä¸ºç©ºï¼Œè‡ªåŠ¨å¼€å§‹
            handleFollowUpClick(currentTopic);
        }
    }

    function addHistoryItem(item) {
        if (!allHistories[currentTopic]) allHistories[currentTopic] = { history: [], pinned: false };
        allHistories[currentTopic].history.push(item);
        saveAllHistories();
    }

    function loadAllHistories() {
        const stored = localStorage.getItem('masterAllHistories'); // æ–°çš„ key
        allHistories = stored ? JSON.parse(stored) : {};
    }

    function saveAllHistories() {
        localStorage.setItem('masterAllHistories', JSON.stringify(allHistories)); // æ–°çš„ key
        renderHistoryList();
    }

    function renderHistoryList() {
        const historyListEl = document.getElementById('history-list');
        if (!historyListEl) return;
        historyListEl.innerHTML = '';
        const topics = Object.keys(allHistories);
        
        // æ’åº (å›ºå®š > å­—æ¯)
        const sortedTopics = topics.sort((a, b) => {
            const aIsPinned = (allHistories[a] && allHistories[a].pinned);
            const bIsPinned = (allHistories[b] && allHistories[b].pinned);
            if (aIsPinned && !bIsPinned) return -1;
            if (!aIsPinned && bIsPinned) return 1;
            return a.localeCompare(b);
        });

        if (sortedTopics.length === 0) {
            historyListEl.innerHTML = `<p class="p-4 text-sm text-gray-500">è¿˜æ²¡æœ‰å¯¹è¯è®°å½•ã€‚</p>`;
            return;
        }

        sortedTopics.forEach(topic => {
            const isPinned = (allHistories[topic] && allHistories[topic].pinned);
            const wrapper = document.createElement('div');
            wrapper.className = `group flex items-center justify-between p-3 text-sm rounded-md ${topic === currentTopic ? 'bg-blue-600 text-white font-bold' : 'hover:bg-gray-700'}`;
            const link = document.createElement('a');
            link.href = "#";
            link.className = 'truncate flex-1';
            link.textContent = isPinned ? `ğŸ“Œ ${topic}` : topic;
            link.onclick = (e) => { e.preventDefault(); switchTopic(topic); };
            
            const menuButton = document.createElement('button');
            menuButton.className = 'context-menu-parent opacity-0 group-hover:opacity-100 transition-opacity ml-2 p-1 rounded-full hover:bg-gray-600';
            menuButton.innerHTML = `<svg class="h-4 w-4 pointer-events-none" fill="currentColor" viewBox="0 0 20 20"><path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"></path></svg>`;
            menuButton.onclick = (e) => { e.stopPropagation(); showContextMenu(e.currentTarget, topic); };
            
            wrapper.appendChild(link);
            wrapper.appendChild(menuButton);
            historyListEl.appendChild(wrapper);
        });
    }
    
    // å³é”®èœå• (ç§»é™¤é”™é¢˜)
    function showContextMenu(button, topic) {
        closeContextMenu(); 
        const rect = button.getBoundingClientRect();
        const menu = document.createElement('div');
        menu.id = 'context-menu';
        menu.className = 'context-menu w-48 bg-gray-800 border border-gray-700 rounded-md shadow-lg py-1';
        menu.style.display = 'block';
        menu.style.top = `${rect.bottom}px`;
        menu.style.left = `${rect.left - 192}px`; // è°ƒæ•´ä½ç½®

        const isPinned = (allHistories[topic] && allHistories[topic].pinned);
        const pinOption = document.createElement('a');
        pinOption.href = '#';
        pinOption.textContent = isPinned ? 'å–æ¶ˆå›ºå®š' : 'å›ºå®š';
        pinOption.className = 'block px-4 py-2 text-sm hover:bg-gray-700';
        pinOption.onclick = (e) => { e.preventDefault(); togglePin(topic); closeContextMenu(); };
        
        // ç§»é™¤äº†é”™é¢˜å¡ç‰‡é€‰é¡¹

        const deleteHistoryOption = document.createElement('a');
        deleteHistoryOption.href = '#';
        deleteHistoryOption.textContent = 'æ¸…ç©ºå¯¹è¯';
        deleteHistoryOption.className = 'block px-4 py-2 text-sm hover:bg-gray-700';
        deleteHistoryOption.onclick = (e) => { e.preventDefault(); deleteHistoryOnly(topic); closeContextMenu(); };
        
        const deleteCompletelyOption = document.createElement('a');
        deleteCompletelyOption.href = '#';
        deleteCompletelyOption.textContent = 'å½»åº•åˆ é™¤';
        deleteCompletelyOption.className = 'block px-4 py-2 text-sm text-red-400 hover:bg-red-900/50';
        deleteCompletelyOption.onclick = (e) => { e.preventDefault(); deleteTopicCompletely(topic); closeContextMenu(); };

        menu.appendChild(pinOption);
        menu.appendChild(deleteHistoryOption);
        menu.appendChild(document.createElement('hr')).className = 'border-gray-700 my-1';
        menu.appendChild(deleteCompletelyOption);
        
        document.body.appendChild(menu);
    }

    function closeContextMenu() {
        const menu = document.getElementById('context-menu');
        if (menu) menu.remove();
    }
    
    function togglePin(topic) {
        if (!allHistories[topic]) return;
        allHistories[topic].pinned = !allHistories[topic].pinned;
        saveAllHistories();
    }

    function deleteHistoryOnly(topic) {
        if (confirm(`ç¡®å®šè¦æ¸…ç©ºä¸»é¢˜ "${topic}" çš„å¯¹è¯å†å²å—ï¼Ÿ`)) {
            if (allHistories[topic]) {
                allHistories[topic].history = [];
                saveAllHistories();
                if (topic === currentTopic) {
                    switchTopic(topic, true); // é‡æ–°å¼€å§‹å½“å‰ä¸»é¢˜
                }
            }
        }
    }
    
    function deleteTopicCompletely(topic) {
        if (confirm(`è­¦å‘Šï¼šç¡®å®šè¦å½»åº•åˆ é™¤ä¸»é¢˜ "${topic}" å—ï¼Ÿ\næ‰€æœ‰å¯¹è¯å†å²éƒ½å°†è¢«æ°¸ä¹…åˆ é™¤ï¼`)) {
            delete allHistories[topic];
            saveAllHistories();
            if (topic === currentTopic) {
                // åˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ªå¯ç”¨ä¸»é¢˜ï¼Œæˆ–é»˜è®¤ä¸»é¢˜
                switchTopic(Object.keys(allHistories)[0] || 'é‡å­åŠ›å­¦', true);
            } else {
                renderHistoryList();
            }
        }
    }
    
    function clearAllHistory() {
        if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å¯¹è¯å†å²å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚')) {
            allHistories = {};
            currentFollowUps = [];
            localStorage.removeItem('masterAllHistories');
            switchTopic('é‡å­åŠ›å­¦', true);
        }
    }

    function loadApiKey() { 
        const savedKey = localStorage.getItem('geminiApiKey'); 
        if (savedKey) { 
            apiKey = savedKey; 
            return true; 
        } 
        return false; 
    }
    
    function setLoading(loadingState) { 
        isLoading = loadingState; 
        const spinner = document.getElementById('loading-spinner');
        if (spinner) spinner.classList.toggle('hidden', !loadingState);
        // æ¸²æŸ“æŒ‰é’®æ—¶ä¼šæ£€æŸ¥ isLoading çŠ¶æ€
        renderFollowUpButtons(currentFollowUps, !loadingState); 
    }
    
    // æ¸²æŸ“åé—®æŒ‰é’® (å·²é‡å†™)
    function renderFollowUpButtons(prompts = [], enabled) { 
        const optionsContainerEl = document.getElementById('options-container');
        if (!optionsContainerEl) return;
        optionsContainerEl.innerHTML = ''; // æ¸…ç©º
        
        if (prompts.length > 0) {
            prompts.forEach((promptText) => { 
                const button = document.createElement('button');
                button.className = 'follow-up-btn w-full';
                button.dataset.prompt = promptText;
                button.disabled = !enabled;
                button.textContent = promptText;
                optionsContainerEl.appendChild(button);
            });
        }
    }

    // æ¸²æŸ“æ¶ˆæ¯åˆ° UI (å·²ç®€åŒ–)
    function addMessageToUI(content, role) {
        const chatMessagesEl = document.getElementById('chat-messages');
        if (!chatMessagesEl) return;
        const wrapper = document.createElement('div');
        
        if (role === 'model') {
            wrapper.classList.add('chat-bubble', 'model');
            // å°†æ¢è¡Œç¬¦ \n æ›¿æ¢ä¸º <br>ï¼Œä»¥ä¾¿åœ¨HTMLä¸­æ­£ç¡®æ˜¾ç¤º
            const formattedText = content.response_text.replace(/\n/g, '<br>');
            wrapper.innerHTML = formattedText;
        } else { // user
            wrapper.classList.add('chat-bubble', 'user');
            wrapper.textContent = content;
        }
        
        chatMessagesEl.appendChild(wrapper);
        // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
        chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
    }
    
    // é”™è¯¯å¤„ç† (ä¿ç•™)
    function handleError(title, rawText, error) {
        console.error(title, error, rawText);
        setLoading(false); // ç¡®ä¿åœæ­¢åŠ è½½
        const chatMessagesEl = document.getElementById('chat-messages');
        if (!chatMessagesEl) return;
        const errorContent = `<p><strong>æŠ±æ­‰ï¼Œå‡ºé”™äº†</strong></p><p>${error.message}</p>${rawText ? `<p><small>åŸå§‹æ•°æ®: ${rawText}</small></p>` : ''}<p>è¯·æ£€æŸ¥æ‚¨çš„ API Key æˆ–ç½‘ç»œè¿æ¥ï¼Œç„¶åå°è¯•æ–°å¯¹è¯ã€‚</p>`;
        const wrapper = document.createElement('div');
        wrapper.className = 'chat-bubble model bg-red-900/50 border border-red-500';
        wrapper.innerHTML = errorContent;
        chatMessagesEl.appendChild(wrapper);
        chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
        // ç¦ç”¨åé—®æŒ‰é’®
        renderFollowUpButtons([], false);
    }

    // --- ç§»é™¤äº†æ‰€æœ‰é”™é¢˜æœ¬/å¡ç‰‡ç›¸å…³çš„å‡½æ•° ---
    // toggleWrongQuestion (removed)
    // startFlashcardReview (removed)
    // renderFlashcardInterface (removed)

</script>
</body>
</html>
